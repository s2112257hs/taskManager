<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
</head>
<body>
    <header>
        <h1>Task Manager</h1>
    </header>
    <main>
        <section>
            <form id="taskForm" method="post">
                <input type="text" id="taskTitle" placeholder="Task Title" required>
                <input type="text" id="taskDescription" placeholder="Task Description">
                <input type="date" id="taskDueDate" placeholder="Due Date">
                <button type="submit">Add Task</button>
            </form>
            <button id="logoutBtn">Logout</button>
        </section>
        <section>
            <ul id="taskList"></ul>
        </section>
    </main>
    <script>
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = "login.html";
        });
        function checkAuth() {
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "login.html";
                return false;
            }
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const now = Math.floor(Date.now() / 1000);
                if (payload.exp && payload.exp < now) {
                    localStorage.removeItem("token"); 
                    window.location.href = "login.html";
                    return false
                }
                return true
            }
            
            catch(e){
                localStorage.removeItem("token");
                return false;

            }
        }

        async function apiRequest(url, options = {}){
            checkAuth();
            if (!checkAuth()){
                return
            }
            const token = localStorage.getItem("token");
            if (!options.headers){
                options.headers = {}
            }
            if (token){
                options.headers["Authorization"] = `Bearer ${token}`
            }
            const response = await fetch(url, options);
            return response;
        }

        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title= document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const dueDate = document.getElementById('taskDueDate').value;

            const response = await apiRequest("http://127.0.0.1:5000/api/tasks",{ 
                method:"POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({title, description, dueDate})
            })
            
            const data = await response.json();
            if (data.error){
                alert(data.error)
            }
            renderTasks();
        })

        async function renderTasks(){
            const response = await apiRequest("http://127.0.0.1:5000/api/tasks", {method: "GET"});
            const data = await response.json();
            console.log(data)
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            data.forEach(task => {
                const li = document.createElement("li");
                li.innerHTML = `<span class='title'> ${task.title ?? ""} </span> |
                                <span class='description'> ${task.description ?? ""} </span> |
                                <span class='dueDate'> ${task.due_date ?? ""} </span> |
                                <button class=editBtn> Edit </button>
                                <button class='deleteBtn'> Delete </button>`;
                
                li.querySelector('.deleteBtn').addEventListener('click', async ()=> {
                    const response = await apiRequest(`http://127.0.0.1:5000/api/tasks/${task.id}`,{
                        method:"DELETE"
                    })
                    const data = await response.json();
                    if (data.error){
                        alert(data.error)
                    }
                    renderTasks();
                })
                
                li.querySelector('.editBtn').addEventListener('click', ()=>{
                    li.innerHTML = `<input class='edit-title' value='${task.title ?? ""}'>|
                                    <input class='edit-description' value='${task.description ?? ""}'>|
                                    <input class='edit-dueDate'type='date' value='${task.due_date ?? ""}'>|
                                    <button class='saveBtn'> Save </button>
                                    <button class='cancelBtn'> Cancel </button>`;
                    
                    li.querySelector('.cancelBtn').addEventListener('click', ()=>{
                        renderTasks();
                    })

                    li.querySelector('.saveBtn').addEventListener('click', async () =>{
                        const title = li.querySelector('.edit-title').value;
                        const description = li.querySelector('.edit-description').value;
                        const dueDate = li.querySelector('.edit-dueDate').value;

                        const response = await apiRequest(`http://127.0.0.1:5000/api/tasks/${task.id}`,{
                            method:"PUT",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({title, description, dueDate})
                        })

                        const data = await response.json();
                        if (data.error){
                            alert(data.error);
                        }
                        renderTasks();
                    })
                })
                taskList.appendChild(li);                       
            })
        }
        checkAuth();
        renderTasks();
    </script>
</body>
</html>