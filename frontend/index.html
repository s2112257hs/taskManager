<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container my-4">
    <header>
        <h1 class="mb-3">Task Manager</h1>
    </header>
    <main>
        <section>
            <div id="errorBox" class="alert alert-danger d-none" role="alert"></div>
            <form id="taskForm" class="mb-4">
                <div class="row g-2">
                    <div class="col-md-3">
                        <input type="text" id="taskTitle" class="form-control" placeholder="Task Title" required>
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="taskDescription" class="form-control" placeholder="Task Description">
                    </div>
                    <div class="col-md-3">
                        <input type="date" id="taskDueDate" class="form-control" placeholder="Due Date">
                    </div>
                    <div class="col-md-2">
                        <select id="taskStatus" class="form-select">
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-primary w-100">Add Task</button>
                    </div>
                </div>
            </form>
            <button id="logoutBtn" class="btn btn-outline-secondary mb-3">Logout</button>
        </section>
        <section>
            <ul id="taskList" class="list-group"></ul>
        </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = "login.html";
        });

        function checkAuth() {
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "login.html";
                return false;
            }
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const now = Math.floor(Date.now() / 1000);
                if (payload.exp && payload.exp < now) {
                    localStorage.removeItem("token");
                    window.location.href = "login.html";
                    return false;
                }
                return true;
            } catch (e) {
                localStorage.removeItem("token");
                window.location.href = "login.html";
                return false;
            }
        }

        async function apiRequest(url, options = {}) {
            if (!checkAuth()) {
                return;
            }
            const token = localStorage.getItem("token");
            if (!options.headers) {
                options.headers = {};
            }
            if (token) {
                options.headers["Authorization"] = `Bearer ${token}`;
            }
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem("token");
                        showError("Session expired or invalid. Please log in again.");
                        window.location.href = "login.html";
                        return null;
                    }
                    return response; // Other errors (e.g., 400, 500) handled by caller
                }
                return response;
            } catch (error) {
                showError("Unable to connect to the server. Please try again later.");
                return null;
            }
        }

        function showError(message) {
            const errorBox = document.getElementById('errorBox');
            errorBox.textContent = message;
            errorBox.classList.remove('d-none');
            setTimeout(() => errorBox.classList.add('d-none'), 5000);
        }

        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const status = document.getElementById('taskStatus').value;

            if (!title.trim()) {
                showError("Task title is required");
                return;
            }

            const response = await apiRequest("http://127.0.0.1:5000/api/tasks", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title, description, dueDate, status })
            });

            if (response) {
                const data = await response.json();
                if (data.error) {
                    showError(data.error);
                } else {
                    document.getElementById('taskForm').reset();
                    renderTasks();
                }
            }
        });

        async function renderTasks() {
            const response = await apiRequest("http://127.0.0.1:5000/api/tasks", { method: "GET" });
            if (!response) return;
            const data = await response.json();
            data.sort((a, b) => (a.status === "pending" && b.status === "completed") ? -1 : (a.status === "completed" && b.status === "pending") ? 1 : 0);
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            data.forEach(task => {
                const li = document.createElement("li");
                li.className = `list-group-item d-flex align-items-center ${task.status === "completed" ? "text-muted" : ""}`;
                li.innerHTML = `
                    <span class="title flex-grow-1 ${task.status === "completed" ? "text-decoration-line-through" : ""}">${task.title ?? ""}</span>
                    <span class="description me-3">${task.description ?? ""}</span>
                    <span class="dueDate me-3">${task.due_date ? "Due: " + task.due_date : ""}</span>
                    <span class="status me-3">${task.status}</span>
                    <button class="editBtn btn btn-outline-primary btn-sm me-2">Edit</button>
                    <button class="deleteBtn btn btn-outline-danger btn-sm">Delete</button>
                `;

                li.querySelector('.deleteBtn').addEventListener('click', async () => {
                    const response = await apiRequest(`http://127.0.0.1:5000/api/tasks/${task.id}`, {
                        method: "DELETE"
                    });
                    if (response) {
                        const data = await response.json();
                        if (data.error) {
                            showError(data.error);
                        }
                        renderTasks();
                    }
                });

                li.querySelector('.editBtn').addEventListener('click', () => {
                    li.innerHTML = `
                        <div class="row g-2">
                            <div class="col-md-3">
                                <input class="edit-title form-control" value="${task.title ?? ""}">
                            </div>
                            <div class="col-md-3">
                                <input class="edit-description form-control" value="${task.description ?? ""}">
                            </div>
                            <div class="col-md-3">
                                <input class="edit-dueDate form-control" type="date" value="${task.due_date ?? ""}">
                            </div>
                            <div class="col-md-2">
                                <select class="edit-status form-select">
                                    <option value="pending" ${task.status === "pending" ? "selected" : ""}>Pending</option>
                                    <option value="completed" ${task.status === "completed" ? "selected" : ""}>Completed</option>
                                </select>
                            </div>
                            <div class="col-md-1 d-flex">
                                <button class="saveBtn btn btn-primary btn-sm me-1">Save</button>
                                <button class="cancelBtn btn btn-secondary btn-sm">Cancel</button>
                            </div>
                        </div>
                    `;

                    li.querySelector('.cancelBtn').addEventListener('click', () => {
                        renderTasks();
                    });

                    li.querySelector('.saveBtn').addEventListener('click', async () => {
                        const title = li.querySelector('.edit-title').value;
                        const description = li.querySelector('.edit-description').value;
                        const dueDate = li.querySelector('.edit-dueDate').value;
                        const status = li.querySelector('.edit-status').value;

                        if (!title.trim()) {
                            showError("Task title is required");
                            return;
                        }

                        const response = await apiRequest(`http://127.0.0.1:5000/api/tasks/${task.id}`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ title, description, dueDate, status })
                        });

                        if (response) {
                            const data = await response.json();
                            if (data.error) {
                                showError(data.error);
                            }
                            renderTasks();
                        }
                    });
                });

                taskList.appendChild(li);
            });
        }

        checkAuth();
        renderTasks();
    </script>
</body>
</html>